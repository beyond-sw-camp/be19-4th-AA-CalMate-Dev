<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ateam.calmate.exerciseRecords.query.mapper.ExerciseRecordQueryMapper">

    <!-- 파일 정보 매핑 -->
    <resultMap id="ExerciseFileResultMap"
               type="com.ateam.calmate.exerciseRecords.query.dto.ExerciseFileResponse">
        <id     column="file_id"      property="fileId"/>
        <result column="file_name"    property="name"/>
        <!-- 최종 이미지 URL -->
        <result column="file_url"     property="url"/>
        <!-- 썸네일 URL (지금은 동일) -->
        <result column="thumb_url"    property="thumbUrl"/>
        <result column="upload_order" property="uploadOrder"/>
    </resultMap>

    <!-- 운동 기록 + 파일 목록 매핑 -->
    <resultMap id="ExerciseRecordResultMap"
               type="com.ateam.calmate.exerciseRecords.query.dto.ExerciseRecordResponse">
        <id     column="exercise_id"  property="exerciseId"/>
        <result column="date"         property="date"/>
        <result column="type"         property="type"/>
        <result column="category"     property="category"/>
        <result column="min"          property="min"/>
        <result column="burned_kcal"  property="burnedKcal"/>
        <result column="create_at"    property="createAt"/>
        <result column="member_id"    property="memberId"/>

        <collection property="files"
                    ofType="com.ateam.calmate.exerciseRecords.query.dto.ExerciseFileResponse"
                    resultMap="ExerciseFileResultMap"/>
    </resultMap>

    <!-- 회원 + 날짜별 운동 기록 목록 조회 -->
    <select id="selectExerciseRecords" resultMap="ExerciseRecordResultMap">
        SELECT
            e.id          AS exercise_id,
            e.date        AS date,
            e.type        AS type,
            e.category    AS category,
            e.min         AS min,
            e.burned_kcal AS burned_kcal,
            e.create_at   AS create_at,
            e.member_id   AS member_id,

            f.id          AS file_id,
            f.name        AS file_name,
            -- url_path = '/img/exercise', re_name = 'uuid.png'
            CONCAT(ep.url_path, '/', f.re_name) AS file_url,
            CONCAT(ep.url_path, '/', f.re_name) AS thumb_url,
            f.upload_order                      AS upload_order
        FROM exercise e
            LEFT JOIN exercise_fileupload f
        ON e.id = f.exercise_id
            LEFT JOIN extend_file_path ep
            ON f.extend_file_path_id = ep.id
        WHERE e.member_id = #{memberId}
          AND e.date = #{date}
        ORDER BY e.date DESC,
            e.create_at DESC,
            e.id DESC,
            f.upload_order ASC
    </select>

    <!-- exerciseId 로 단건 조회 -->
    <select id="selectExerciseRecordById" resultMap="ExerciseRecordResultMap">
        SELECT
            e.id          AS exercise_id,
            e.date        AS date,
            e.type        AS type,
            e.category    AS category,
            e.min         AS min,
            e.burned_kcal AS burned_kcal,
            e.create_at   AS create_at,
            e.member_id   AS member_id,

            f.id          AS file_id,
            f.name        AS file_name,
            CONCAT(ep.url_path, '/', f.re_name) AS file_url,
            CONCAT(ep.url_path, '/', f.re_name) AS thumb_url,
            f.upload_order                      AS upload_order
        FROM exercise e
            LEFT JOIN exercise_fileupload f
        ON e.id = f.exercise_id
            LEFT JOIN extend_file_path ep
            ON f.extend_file_path_id = ep.id
        WHERE e.id = #{exerciseId}
        ORDER BY e.date DESC,
            e.create_at DESC,
            e.id DESC,
            f.upload_order ASC
    </select>

</mapper>
