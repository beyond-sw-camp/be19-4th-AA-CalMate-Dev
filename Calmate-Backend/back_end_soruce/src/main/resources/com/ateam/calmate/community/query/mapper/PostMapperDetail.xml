<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ateam.calmate.community.query.mapper.PostMapperDetail">

    <select id="findPostDetail" resultType="com.ateam.calmate.community.query.dto.PostDetailDTO">
        SELECT
            p.id AS id,
            p.title AS title,
            p.content AS content,
--             DATE_FORMAT(p.created_at, '%Y-%m-%d %H:%i') AS createdAt,
            DATE_FORMAT(CONVERT_TZ(p.created_at, '+00:00', '+09:00'), '%Y-%m-%d %H:%i') AS createdAt,
            m.nickname AS authorName,
            p.member_id AS memberId,                <!-- ✅ 게시글 작성자 memberId 추가 -->
            p.visibility AS visibility,
            t.name AS tagName,
            p.tag_id AS tagId,                <!-- ✅ 여기가 핵심 -->
            (SELECT COUNT(*) FROM post_like pl WHERE pl.post_id = p.id) AS likes,
            (SELECT COUNT(*) FROM post_comment pc WHERE pc.post_id = p.id) AS comments,

            CASE
                WHEN EXISTS (
                    SELECT 1 FROM post_like pl2
                    WHERE pl2.post_id = p.id AND pl2.member_id = #{memberId}
                ) THEN TRUE
                ELSE FALSE
                END AS liked

        FROM post p
                 JOIN member m ON p.member_id = m.id
                 LEFT JOIN tag t ON p.tag_id = t.id
        WHERE p.id = #{postId}
    </select>

</mapper>
